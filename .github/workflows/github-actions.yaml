name: Main
on:
  - push
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        ports: 
          - 1433:1433
        env:
          ACCEPT_EULA: "Y"
          MSSQL_SA_PASSWORD: ${{ secrets.DB_BUILD_PASSWORD }}
          MSSQL_PID: "Express"
          MSSQL_COLLATION: "SQL_Latin1_General_CP1_CI_AS"
    steps:
      - uses: actions/checkout@v2
        env: 
          FLYWAY_URL: ${{ secrets.BUILD.DB_BUILD_URL }}
          FLYWAY_USER: ${{ secrets.DB_BUILD_USERNAME }}
          FLYWAY_PASSWORD: ${{ secrets.DB_BUILD_PASSWORD }}
          FLYWAY_VALIDATE_MIGRATION_NAMING: true  
      - run: echo 'testing'

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install OpenJDK
        run: sudo apt-get install -y openjdk-11-jdk
     
      - name: Download and Install Flyway CLI
        run: wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.21.1/flyway-commandline-9.21.1-linux-x64.tar.gz | tar -xvz && ln -s `pwd`/flyway-9.21.1/flyway /usr/local/bin

      - name: Set Flyway Path
        run: PATH=/flyway:$PATH

      - name: Configuring Flyway on aws EC2  
        env: 
          FLYWAY_URL: ${{ secrets.BUILD.DB_BUILD_URL }}
          FLYWAY_USER: ${{ secrets.DB_BUILD_USERNAME }}
          FLYWAY_PASSWORD: ${{ secrets.DB_BUILD_PASSWORD }}
          FLYWAY_VALIDATE_MIGRATION_NAMING: true  
        run: touch flyway.conf ;
          echo "${{ secrets.DB_BUILD_URL }}" ;
          echo "flyway.url=jdbc:sqlserver://dblevelupinstance.csxil53pu1c8.eu-west-1.rds.amazonaws.com:1433;encrypt=true;trustServerCertificate=true;" >> flyway.conf ;
          echo "flyway.user=${{ secrets.DB_BUILD_USERNAME }}" >> flyway.conf ;
          echo "flyway.password=${{ secrets.DB_BUILD_PASSWORD }}" >> flyway.conf ;

      - name: Run Flyway Info      
        env: 
          FLYWAY_URL: ${{ secrets.DB_BUILD_URL }}
          FLYWAY_USER: ${{ secrets.DB_BUILD_USERNAME }}
          FLYWAY_PASSWORD: ${{ secrets.DB_BUILD_PASSWORD }}
          FLYWAY_VALIDATE_MIGRATION_NAMING: true  
        run: flyway info
        continue-on-error: true

      - name: Run Flyway Migrate
        env: 
          FLYWAY_URL: ${{ secrets.DB_BUILD_URL }}
          FLYWAY_USER: ${{ secrets.DB_BUILD_USERNAME }}
          FLYWAY_PASSWORD: ${{ secrets.DB_BUILD_PASSWORD }}
          FLYWAY_VALIDATE_MIGRATION_NAMING: true  
        run: flyway migrate
