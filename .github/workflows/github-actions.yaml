name: Main
on:
  - push
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        ports: 
          - 1433:1433
        env:
          ACCEPT_EULA: "Y"
          MSSQL_SA_PASSWORD: ${{ secrets.DB_BUILD_PASSWORD }}
          MSSQL_PID: "Express"
          MSSQL_COLLATION: "SQL_Latin1_General_CP1_CI_AS"
    steps:
      - uses: actions/checkout@v2
        env: 
          FLYWAY_URL: ${{ secrets.DB_BUILD_URL }}
          FLYWAY_USER: ${{ secrets.DB_BUILD_USERNAME }}
          FLYWAY_PASSWORD: ${{ secrets.DB_BUILD_PASSWORD }}
          FLYWAY_VALIDATE_MIGRATION_NAMING: true  
      - run: echo 'testing'

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install OpenJDK
        run: sudo apt-get install -y openjdk-11-jdk

      # - name: Download, Unzip Flyway
      #   run: wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/8.5.6/flyway-commandline-8.5.6-linux-x64.tar.gz | tar xvz
      #     sudo mv flyway-8.5.6 /opt/flyway

      - name: Configuring Flyway on aws EC2
        run: touch flyway.conf ;
          echo "flyway.url=jdbc:sqlserver://${{ secrets.DB_BUILD_URL }}:1433;encrypt=true;trustServerCertificate=true;" >> flyway.conf ;
          echo "flyway.user=${{ secrets.DB_BUILD_USERNAME }}" >> flyway.conf ;
          echo "flyway.password=${{ secrets.DB_BUILD_PASSWORD }}" >> flyway.conf ;

      - name: Run Flyway Info
        run: ./flyway info
        continue-on-error: true

      - name: Run Flyway Migrate
        run: cd /opt/flyway
          ./flyway migrate
